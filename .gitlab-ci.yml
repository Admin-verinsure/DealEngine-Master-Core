stages:
  - build
  - deploy

before_script:  

# Runner server requires following for build
# dotnet-sdk-3.1
# dotnet-sdk-2.2

build:
  stage: build
  script:
    - echo "Cleaning previous build..."
    #- 'dotnet clean'
    - echo "Building project..."
    #- 'dotnet build -c Release'

before_script:

deploy_staging:
  stage: deploy
  script:
  - eval "$(ssh-agent -s)"
  - ssh-add <(echo "$PKgitlab")
  
#script 1
  - ssh ubuntu@"$URLdevops" 'ls -la'
#  - ssh ubuntu@"$URLdevops" './DE-DeployPrep.sh'

  - ssh ubuntu@"$URLdevops" 'bash -s' < DE-DeployPrep.sh'

#  - ssh ubuntu@"$URLdevops" 'mkdir -p /home/ubuntu/projects'
#  - ssh ubuntu@"$URLdevops" 'mkdir -p /home/ubuntu/backup'
#  - ssh ubuntu@"$URLdevops" 'mkdir -p /home/ubuntu/backup/images'
#  - ssh ubuntu@"$URLdevops" 'cp -R /var/www/dealengine/publish/wwwroot/images/* /home/ubuntu/backup/images'
#  - ssh ubuntu@"$URLdevops" 'cp -R /var/www/dealengine/publish/appsettings.json /home/ubuntu/backup/appsettings.json'   
#  - ssh ubuntu@"$URLdevops" 'rm -rf /home/ubuntu/projects/dealengine/*'
#  - ssh ubuntu@"$URLdevops" 'sudo systemctl stop dealengine'
  
  - 'dotnet publish -c Release'
  - rsync -azhe ssh /home/gitlab-runner/builds/MsHgSUxs/0/tcdev/de2020master/TechCertain.WebUI/bin/Release/netcoreapp3.1/ ubuntu@$URLdevops:/home/ubuntu/projects/dealengine
  
#script 2
  - ssh ubuntu@"$URLdevops" 'mkdir -p /var/www/dealengine/publish/wwwroot/images'
  - ssh ubuntu@"$URLdevops" 'cp /home/ubuntu/backup/appsettings.json /var/www/dealengine/publish/appsettings.json'
  - ssh ubuntu@"$URLdevops" 'cp -R /home/ubuntu/backup/images/* /var/www/dealengine/publish/wwwroot/images'
  - ssh ubuntu@"$URLdevops" 'sudo systemctl start dealengine'

# useful - #  - ssh -o StrictHostKeyChecking=no ubuntu@"$URLmpak" ''

  environment:
    name: staging
    url: https://devops.techcertain.com
  when: manual
  dependencies:
    - build

deploy_marsh:
  stage: deploy
  script:
  - echo "Compiling code..."
  - 'dotnet publish -c Release --self-contained -r ubuntu.18.04-x64'

#  - echo "Establishing Connection to devops.techcertain.com..."
#  - ssh-add <(echo "$PRIVATE_KEY")
#  - ssh -o StrictHostKeyChecking=no user@"$QA_SERVER" 'rm -rf /var/www/html/*'
#  - scp -P22 -r . ubuntu@"$QA_SERVER":/var/www/dealengine
#  - rsync -azhe ssh /path/to/project ubuntu@devops.techcertain.com:/home/ubuntu/
#  Restart dealengine service
#  - echo "Restarting DealEngine Service...

  environment:
    name: marsh
    url: https://staging.mnzconnect.com
  when: manual
#  dependencies:
#    - build

deploy_insw:
  stage: deploy
  script:
  - echo "Compiling code..."
  - 'dotnet publish -c Release --self-contained -r ubuntu.18.04-x64'

#  - echo "Establishing Connection to dealengine.tai.co.nz..."
#  - ssh-add <(echo "$PRIVATE_KEY")
#  - ssh -o StrictHostKeyChecking=no user@"$QA_SERVER" 'rm -rf /var/www/html/*'
#  - scp -P22 -r . ubuntu@"$QA_SERVER":/var/www/dealengine
#  - rsync -azhe ssh /path/to/project ubuntu@devops.techcertain.com:/home/ubuntu/
#  Restart dealengine service
#  - echo "Restarting DealEngine Service...

  environment:
    name: insw
    url: https://dealengine.tai.co.nz
  when: manual
  dependencies:
#    - build
