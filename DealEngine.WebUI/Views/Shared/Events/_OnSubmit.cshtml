<script type="text/javascript">

    function ElementOnSubmit(Element, TargetElement, Form, Panel) {
        var tag = TargetElement.tagName;
        //hardcoded for project table
        if (tag == "TABLE") {
            if (TargetElement.rows.length < 2) {
                event.preventDefault();
                event.stopPropagation();
                $("#more").trigger("click");
                //go back to div// go back to accordion to get id
                var accordianId = Form.getAttribute('data-accordianId');
                window.alert("Please provide a project");
                $("[id='" + accordianId + "']").trigger("click");
                Element.scrollIntoView();
                throw accordianId + " incomplete";
            }
        }
    }

    function RoleDataOnSubmit(ElementId, Form) {
        var element = document.getElementById(ElementId);
        var tabId = element.parentElement.parentElement.parentElement.parentElement.id;
        var multiElement = element.selectedOptions.length;
        if (multiElement == 0) {
            event.preventDefault();
            event.stopPropagation();
            $("#more").trigger("click");
            var accordianId = Form.getAttribute('data-accordianId');
            $("[id='Roles']").trigger("click");
            window.alert("Roles not selected");
            SetCurrentTab(tabId);
            element.scrollIntoView();
            throw accordianId + " incomplete";
        } else {
            var tabNo = parseInt(tabId.substring(tabId.length - 1)) + 1;
            var nextTab = tabId.substring(0, tabId.length - 1);
            SetCurrentTab(nextTab + tabNo);
        }
    }

    function RevenueDataOnSubmit(ElementId, Form) {
        var element = document.getElementById(ElementId);
        var tabId = element.parentElement.parentElement.parentElement.parentElement.id;
        var totalPercentage = 0;
        var tableElement;
        for (var v = 0; v < element.selectedOptions.length; v++) {
            tableElement = document.getElementById(element.selectedOptions[v].text);
            var value = parseInt(tableElement.value);
            totalPercentage += value;
        }
        if (totalPercentage != 100) {
            try {
                tableElement.classList.remove("is-valid");
                tableElement.classList.add("is-invalid");
                event.preventDefault();
                event.stopPropagation();
                $("#more").trigger("click");
                var accordianId = Form.getAttribute('data-accordianId');
                $("[id='Fee Income / Activities']").trigger("click");
                window.alert("Activities or Territories percentage calculation does not equal to 100%");
                SetCurrentTab(tabId);
                element.scrollIntoView();
                throw accordianId + " incomplete";
            }
            catch (ex) {
                //assume the drop down is empty so divert back to income
                event.preventDefault();
                event.stopPropagation();
                $("#more").trigger("click");
                var accordianId = Form.getAttribute('data-accordianId');
                $("[id='Fee Income / Activities']").trigger("click");
                window.alert("Activities or Territories not selected");
                SetCurrentTab(tabId);
                element.scrollIntoView();
                throw accordianId + " incomplete";
            }

        }
        else {
            tableElement.classList.add("is-valid");
            tableElement.classList.remove("is-invalid");
            var tabNo = parseInt(tabId.substring(tabId.length - 1)) + 1;
            var nextTab = tabId.substring(0, tabId.length - 1);
            SetCurrentTab(nextTab + tabNo);
        }
    }

    function InformationSheetSubmit(Programme, Status, Forms) {
        debugger;
        if (Status === "Started") {
            var formIds = [];
            for (var f = 0; f < Forms.length; f++) {
                //get each form id
                if (Forms[f].id !== "organisationViewModel") {
                    formIds.push(Forms[f].id);
                }
            }
            for (var i = 0; i < formIds.length; i++) {
                var form = document.getElementById(formIds[i]);
                var element = null;
                for (var e = 0; e < form.length; e++) {
                    //for (var e = form.length-1; e > 0; e--) {
                    try {
                        if (form[e].id != "") {
                            element = document.getElementById(form[e].id);
                        }
                        else {
                            element = null;
                        }
                    }
                    catch (ex) {
                        //will have to add further function for forms with added elements
                    }
                    if (element != null) {
                        if (element.multiple == true && (form.id == "RoleDataViewModel" || form.id == "RevenueDataViewModel")) {
                            //need to cancel event for build tables i.e role/revenue
                            if (form.id == "RevenueDataViewModel") {
                                RevenueDataOnSubmit(element.id, form);
                            }
                            if (form.id == "RoleDataViewModel") {
                                RoleDataOnSubmit(element.id, form);
                            }
                        }
                        else {
                            //hardcoded to find the div visibility - need to find a better way  
                            var isHidden = element.parentElement.parentElement.parentElement.parentElement.hidden;//IsElementHidden(element);
                            if (isHidden == false) {
                                OnChange(element.id, element.name);
                                //onsubmitfunction trigger
                                var hasOnsubmitValidation = element.getAttribute("data-onsubmititem");
                                var validationelement = document.getElementById(hasOnsubmitValidation);
                                if (validationelement != null) {
                                    ElementOnSubmit(element, validationelement, form)
                                }
                                if (element.classList.contains("is-invalid")) {
                                    //write a message here or stop the process
                                    debugger;
                                    event.preventDefault();
                                    event.stopPropagation();
                                    $("#more").trigger("click");
                                    //go back to div// go back to accordion to get id
                                    var accordianId = form.getAttribute('data-accordianId');
                                    if (accordianId == null) {
                                        throw "update form accordianId " + form.id;
                                        debugger;
                                    }
                                    window.alert("Please complete this section " + accordianId);
                                    $("[id='" + accordianId + "']").trigger("click");
                                    element.scrollIntoView();
                                    throw accordianId + " incomplete";
                                }
                            }
                        }
                    }
                }
                form.classList.remove("needs-validation");
                form.classList.add("was-validated");
            }
            UnitValidationOnSubmit(Programme);         
            LocationValidationOnSubmit();
        }
    }

    function LocationValidationOnSubmit() {
        var location = document.getElementById("tblLocation");
        if (location != null) {
            if (location.rows[1].className == "no-records-found") {
                event.preventDefault();
                event.stopPropagation();
                window.alert("Please complete Location section ");
                $("[id='Location']").trigger("click");
                $("#more").trigger("click");
                throw "Location Missing";
            }
        }
    }

    function UnitValidationOnSubmit(Programme) {
        var Unit = document.getElementsByName("Unit");


        if (Unit != null) {
            if (Unit.length > 0) {
                if (Unit[0].id == "AdvisorUnit" ||
                    Unit[0].id == "PlannerUnit"
                ) {
                    var pAdvisor = document.getElementById("IsPrincipal");
                    if (pAdvisor == null) {
                        event.preventDefault();
                        event.stopPropagation();
                        $("#more").trigger("click");
                        $("[id='Insured Details / Named Parties']").trigger("click");
                        window.alert("A Principal Named Party needs to be declared in the Named Parties panel to proceed. ");
                        throw "no principal selected";
                    }
                    else {
                        var organisations = document.querySelectorAll('[data-IsPrincipal="True"]'); //getAttribute("");
                        if (organisations.length != 1) {
                            event.preventDefault();
                            event.stopPropagation();
                            $("#more").trigger("click");
                            window.alert("A Principal Named Party needs to be declared in the Named Parties panel to proceed.");
                            $("[id='Insured Details / Named Parties']").trigger("click");
                            element.scrollIntoView();
                            throw "no principal selected";
                        }
                    }

                    if (Programme != "Apollo Programme" && Programme != "Abbott Financial Advisor Liability Programme") {
                        var TradingName = document.getElementById("NoTradingName");
                        if (TradingName != null) {
                            if (TradingName.value === "True") {
                                event.preventDefault();
                                event.stopPropagation();
                                $("#more").trigger("click");
                                window.alert("Please add 'Trading Name' for 'Owner' in Named Parties");
                                $("[id='Insured Details / Named Parties']").trigger("click");
                                throw "no trading name";
                            }
                        }
                    }
                    
                    var DateofIncorportation = document.getElementById("NoDateofIncorportation");
                    if (DateofIncorportation != null) {
                        if (DateofIncorportation.value === "True") {
                            event.preventDefault();
                            event.stopPropagation();
                            $("#more").trigger("click");
                            window.alert("Please add 'Date of Incorportation' for 'Owner' in Named Parties");
                            $("[id='Insured Details / Named Parties']").trigger("click");
                            throw "no Date of Incorportation";
                        }
                    }
                }
            }
        }    
        var InvalidEmail = document.getElementById("ValidBackEndEmail");
        if (InvalidEmail != null) {
            event.preventDefault();
            event.stopPropagation();
            $("#more").trigger("click");
            $("[id='Insured Details / Named Parties']").trigger("click");
            window.alert("Please update email for: " + InvalidEmail.value);
            throw "InvalidEmail Named Parties";
        }
    }

    function OnOrganisationSubmit(FormId, AccordionId) {
        var PostAjax = true;
        var RemoveAdvisors = false;
        var RemoveIsTheFAPS = false;

        var form = document.getElementById(FormId);
        var ErrorMessage = "";
        debugger;
        var selectElement = document.getElementById('Organisation.InsuranceAttribute');
                      
        var output = selectElement.value;
        debugger;
        if (output == "Administrator") {
            debugger;
            var selectElement = document.getElementById('AdministratorUnit.isAdministratorTheFAP');
            if (selectElement != null &&  selectElement.value == "true") {
                if (document.getElementById("AdministratorUnit.FAPAdministratorLicenseNumber").value == "")
                {
                    window.alert("Please enter a FAP License number.");
                     throw "Please enter a FAP License number.";
                }
            }
        }
         if (output == "Advisor") {
            debugger;
            var selectElement = document.getElementById('AdvisorUnit.isTheFAP');
            if (selectElement != null && selectElement.value == "true") {
                if (document.getElementById("AdvisorUnit.FAPLicenseNumber").value == "")
                {
                 window.alert("Please enter a FAP License number.");
                    throw "Please enter a FAP License number.";
                }
            }
        }


         var selectElement = document.getElementById('Organisation.isOrganisationTheFAP');
            if (selectElement != null && selectElement.value == "true") {
                if (document.getElementById("Organisation.OrganisationFAPLicenseNumber").value == "")
                {
                    window.alert("Please enter a FAP License number.");
                    throw "Please enter a FAP License number.";
                }

            }
        //  document.getElementsByName("Unit").value="AdministratorUnit"

           
        

        if (FormId === "organisationViewModel") {
            for (var i = 0; i < form.length; i++) {
                try {
                    if (form[i].id != "") {
                        var element = document.getElementById(form[i].id);
                        OnChange(element.id, element.name);
                        var dataRule = element.getAttribute('data-rule');
                        if (dataRule == "PrincipalAdvisor") {
                            if (element[element.selectedIndex].value == "true") {
                                RemoveAdvisors = true;
                            }
                        }

                         if (dataRule == "IsTheFap") {
                            if (element[element.selectedIndex].value == "true") {
                                RemoveIsTheFAPS = true;
                            }
                        }

                        
                        if (dataRule == "RetirementDateValidation" && output == "Advisor") {
                            if (element[element.selectedIndex].value == "true") {
                                if (document.getElementById("AdvisorUnit.DateofRetirement").value == ""
                                    && document.getElementById("AdvisorUnit.DateofDeceased").value == "") {
                                    throw "If this person has retired or deceased, then please complete either 'Date of Retirement' or 'Date of Deceased'";
                                }
                            }
                        }
                         
                        if (dataRule == "RetirementDateValidation" && output == "Director") {
                            if (element[element.selectedIndex].value == "true") {
                                if (document.getElementById("DirectorUnit.DateofRetirement").value == ""
                                    && document.getElementById("DirectorUnit.DateofDeceased").value == "") {
                                    throw "If this person has retired or deceased, then please complete either 'Date of Retirement' or 'Date of Deceased'";
                                }
                            }
                        }
                        var IsHidden = IsElementHidden(element);
                        if (element.classList.contains("is-invalid") && (IsHidden != true)) {
                            PostAjax = false;
                            debugger;
                            throw  "Please complete the form";
                        }
                    }
                }
                catch (ex) {
                    debugger;
                    PostAjax = false;
                    console.log(ex, element.Name);
                    ErrorMessage = ex;
                    event.preventDefault();
                    event.stopPropagation();
                }
            }
        }
        if (PostAjax) {
            $('#getDetailsModal').modal('show');
            try {
                sessionStorage.setItem('accordianTrigger', AccordionId);
                if (RemoveAdvisors) {
                    $.ajax({
                        url: '@Url.Action("RemovePrincipalAdvisors", "Organisation")',
                        type: "POST",
                        async: false,
                        data: $("#" + form.id).serialize(),
                        error: function (request, error) {
                            debugger;
                        }
                    });
                }

                 if (RemoveIsTheFAPS) {
                    $.ajax({
                        url: '@Url.Action("RemoveIsTheFAPS", "Organisation")',
                        type: "POST",
                        async: false,
                        data: $("#" + form.id).serialize(),
                        error: function (request, error) {
                            debugger;
                        }
                    });
                }
                var serializeddata = $("#" + form.id).serialize();
                $.ajax({
                    url: '@Url.Action("AddOrganisation", "Organisation")',
                    type: "POST",
                    async: false,
                    data: $("#" + form.id).serialize(),
                    success: function (Data) {
                        location.reload();
                    }, error: function (request, error) {
                        debugger;
                    }
                });
            }
            catch (ex) {
                debugger;
                console.log(ex, element.Name);
            }
            $('#getDetailsModal').modal('hide');
        }
        else {
             window.alert(ErrorMessage);
        }
    }

</script>