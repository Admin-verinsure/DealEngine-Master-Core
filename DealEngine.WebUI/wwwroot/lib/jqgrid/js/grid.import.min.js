!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.utils","./grid.base"],e):e(jQuery)}(function(y){"use strict";y.jgrid=y.jgrid||{},y.extend(y.jgrid,{saveState:function(e,t){if(t=y.extend({useStorage:!0,storageType:"localStorage",beforeSetItem:null,compression:!1,compressionModule:"LZString",compressionMethod:"compressToUTF16",debug:!1,saveData:!0},t||{}),e){var r,i,o,a="",n="",d=y("#"+e)[0];if(d.grid){if((o=y(d).data("inlineNav"))&&d.p.inlineNav&&y(d).jqGrid("setGridParam",{_iN:o}),(o=y(d).data("filterToolbar"))&&d.p.filterToolbar&&y(d).jqGrid("setGridParam",{_fT:o}),a=y(d).jqGrid("jqGridExport",{exptype:"jsonstring",ident:"",root:"",data:t.saveData}),n="",t.saveData&&(i=(n=y(d.grid.bDiv).find(".ui-jqgrid-btable tbody:first").html()).indexOf("</tr>"),n=n.slice(i+5)),y.isFunction(t.beforeSetItem)&&null!=(r=t.beforeSetItem.call(d,a))&&(a=r),t.debug){y("#gbox_tree").prepend('<a id="link_save" target="_blank" download="jqGrid_dump.txt">Click to save Dump Data</a>');var s,l,p=[],c={};p.push("Grid Options\n"),p.push(a),p.push("\n"),p.push("GridData\n"),p.push(n),c.type="plain/text;charset=utf-8";try{s=new File(p,"jqGrid_dump.txt",c)}catch(e){s=new Blob(p,c)}l=URL.createObjectURL(s),y("#link_save").attr("href",l).on("click",function(){y(this).remove()})}if(t.compression&&t.compressionModule)try{null!=(r=window[t.compressionModule][t.compressionMethod](a))&&(a=r,n=window[t.compressionModule][t.compressionMethod](n))}catch(e){}if(t.useStorage&&y.jgrid.isLocalStorage())try{window[t.storageType].setItem("jqGrid"+d.p.id,a),window[t.storageType].setItem("jqGrid"+d.p.id+"_data",n)}catch(e){22===e.code&&alert("Local storage limit is over!")}return a}}},loadState:function(e,t,r){if(r=y.extend({useStorage:!0,storageType:"localStorage",clearAfterLoad:!1,beforeSetGrid:null,afterSetGrid:null,decompression:!1,decompressionModule:"LZString",decompressionMethod:"decompressFromUTF16",restoreData:!0},r||{}),e){var o,i,a,n,d,s=y("#"+e)[0];if(r.useStorage)try{t=window[r.storageType].getItem("jqGrid"+s.id),a=window[r.storageType].getItem("jqGrid"+s.id+"_data")}catch(e){}if(t){if(r.decompression&&r.decompressionModule)try{null!=(o=window[r.decompressionModule][r.decompressionMethod](t))&&(t=o,a=window[r.decompressionModule][r.decompressionMethod](a))}catch(e){}if((o=y.jgrid.parseFunc(t))&&"object"===y.type(o)){s.grid&&y.jgrid.gridUnload(e),y.isFunction(r.beforeSetGrid)&&(i=r.beforeSetGrid(o))&&"object"===y.type(i)&&(o=i);var l=function(e){return e},p={reccount:o.reccount,records:o.records,lastpage:o.lastpage,shrinkToFit:l(o.shrinkToFit),data:l(o.data),datatype:l(o.datatype),grouping:l(o.grouping)};o.shrinkToFit=!1,o.data=[],o.datatype="local",o.grouping=!1,o.inlineNav&&(n=l(o._iN),o._iN=null,delete o._iN),o.filterToolbar&&(d=l(o._fT),o._fT=null,delete o._fT);var c,g,u=y("#"+e).jqGrid(o);if(u.jqGrid("delRowData","norecs"),r.restoreData&&""!==y.trim(a)&&u.append(a),u.jqGrid("setGridParam",p),o.storeNavOptions&&o.navGrid&&(u[0].p.navGrid=!1,u.jqGrid("navGrid",o.pager,o.navOptions,o.editOptions,o.addOptions,o.delOptions,o.searchOptions,o.viewOptions),o.navButtons&&o.navButtons.length))for(var m=0;m<o.navButtons.length;m++)"sepclass"in o.navButtons[m][1]?u.jqGrid("navSeparatorAdd",o.navButtons[m][0],o.navButtons[m][1]):u.jqGrid("navButtonAdd",o.navButtons[m][0],o.navButtons[m][1]);if(u[0].refreshIndex(),o.subGrid&&(c=1===o.multiselect?1:0,g=!0===o.rownumbers?1:0,u.jqGrid("addSubGrid",c+g),y.each(u[0].rows,function(e,t){y(t).hasClass("ui-sg-expanded")&&y(u[0].rows[e-1]).find("td.sgexpanded").click().click()})),o.treeGrid)for(var f=1,j=u[0].rows.length,G=o.expColInd,x=o.treeReader.leaf_field,v=o.treeReader.expanded_field;f<j;)y(u[0].rows[f].cells[G]).find("div.treeclick").on("click",function(e){var t=e.target||e.srcElement,r=y.jgrid.stripPref(o.idPrefix,y(t,u[0].rows).closest("tr.jqgrow")[0].id),i=u[0].p._index[r];return u[0].p.data[i][x]||(u[0].p.data[i][v]?(u.jqGrid("collapseRow",u[0].p.data[i]),u.jqGrid("collapseNode",u[0].p.data[i])):(u.jqGrid("expandRow",u[0].p.data[i]),u.jqGrid("expandNode",u[0].p.data[i]))),!1}),!0===o.ExpandColClick&&y(u[0].rows[f].cells[G]).find("span.cell-wrapper").css("cursor","pointer").on("click",function(e){var t=e.target||e.srcElement,r=y.jgrid.stripPref(o.idPrefix,y(t,u[0].rows).closest("tr.jqgrow")[0].id),i=u[0].p._index[r];return u[0].p.data[i][x]||(u[0].p.data[i][v]?(u.jqGrid("collapseRow",u[0].p.data[i]),u.jqGrid("collapseNode",u[0].p.data[i])):(u.jqGrid("expandRow",u[0].p.data[i]),u.jqGrid("expandNode",u[0].p.data[i]))),u.jqGrid("setSelection",r),!1}),f++;o.multiselect&&y.each(o.selarrrow,function(){y("#jqg_"+e+"_"+this)[o.useProp?"prop":"attr"]("checked","checked")}),o.inlineNav&&n&&(u.jqGrid("setGridParam",{inlineNav:!1}),u.jqGrid("inlineNav",o.pager,n)),o.filterToolbar&&d&&(u.jqGrid("setGridParam",{filterToolbar:!1}),d.restoreFromFilters=!0,u.jqGrid("filterToolbar",d)),o.frozenColumns&&u.jqGrid("setFrozenColumns"),u[0].updatepager(!0,!0),y.isFunction(r.afterSetGrid)&&r.afterSetGrid(u),r.clearAfterLoad&&(window[r.storageType].removeItem("jqGrid"+s.id),window[r.storageType].removeItem("jqGrid"+s.id+"_data"))}else alert("can not convert to object")}}},isGridInStorage:function(e,t){var r,i,o,a={storageType:"localStorage"},a=y.extend(a,t||{});try{i=window[a.storageType].getItem("jqGrid"+e),o=window[a.storageType].getItem("jqGrid"+e+"_data"),r=null!=i&&null!=o&&"string"==typeof i&&"string"==typeof o}catch(e){r=!1}return r},setRegional:function(e,t){var r={storageType:"sessionStorage"};if((r=y.extend(r,t||{})).regional){y.jgrid.saveState(e,r),r.beforeSetGrid=function(e){return e.regional=r.regional,e.force_regional=!0,e},y.jgrid.loadState(e,null,r);var i=y("#"+e)[0],o=y(i).jqGrid("getGridParam","colModel"),a=-1,n=y.jgrid.getRegional(i,"nav");y.each(o,function(e){if(this.formatter&&"actions"===this.formatter)return a=e,!1}),-1!==a&&n&&y("#"+e+" tbody tr").each(function(){var e=this.cells[a];y(e).find(".ui-inline-edit").attr("title",n.edittitle),y(e).find(".ui-inline-del").attr("title",n.deltitle),y(e).find(".ui-inline-save").attr("title",n.savetitle),y(e).find(".ui-inline-cancel").attr("title",n.canceltitle)});try{window[r.storageType].removeItem("jqGrid"+i.id),window[r.storageType].removeItem("jqGrid"+i.id+"_data")}catch(e){}}},jqGridImport:function(e,r){r=y.extend({imptype:"xml",impstring:"",impurl:"",mtype:"GET",impData:{},xmlGrid:{config:"root>grid",data:"root>rows"},jsonGrid:{config:"grid",data:"data"},ajaxOptions:{}},r||{});function i(e,t){var r,i,o,a,n=y(t.xmlGrid.config,e)[0],d=y(t.xmlGrid.data,e)[0];if(y.grid.xmlToJSON){for(o in r=y.jgrid.xmlToJSON(n))r.hasOwnProperty(o)&&(i=r[o]);d?(a=r.grid.datatype,r.grid.datatype="xmlstring",r.grid.datastr=e,y(s).jqGrid(i).jqGrid("setGridParam",{datatype:a})):setTimeout(function(){y(s).jqGrid(i)},0)}else alert("xml2json or parse are not present")}function t(e,t){var r,i,o,a;e&&"string"==typeof e&&(i=(r=y.jgrid.parseFunc(e))[t.jsonGrid.config],(o=r[t.jsonGrid.data])?(a=i.datatype,i.datatype="jsonstring",i.datastr=o,y(s).jqGrid(i).jqGrid("setGridParam",{datatype:a})):y(s).jqGrid(i))}var o,s=(0===e.indexOf("#")?"":"#")+y.jgrid.jqID(e);switch(r.imptype){case"xml":y.ajax(y.extend({url:r.impurl,type:r.mtype,data:r.impData,dataType:"xml",complete:function(e,t){"success"===t&&(i(e.responseXML,r),y(s).triggerHandler("jqGridImportComplete",[e,r]),y.isFunction(r.importComplete)&&r.importComplete(e)),e=null}},r.ajaxOptions));break;case"xmlstring":!r.impstring||"string"!=typeof r.impstring||(o=y.parseXML(r.impstring))&&(i(o,r),y(s).triggerHandler("jqGridImportComplete",[o,r]),y.isFunction(r.importComplete)&&r.importComplete(o));break;case"json":y.ajax(y.extend({url:r.impurl,type:r.mtype,data:r.impData,dataType:"json",complete:function(e){try{t(e.responseText,r),y(s).triggerHandler("jqGridImportComplete",[e,r]),y.isFunction(r.importComplete)&&r.importComplete(e)}catch(e){}e=null}},r.ajaxOptions));break;case"jsonstring":r.impstring&&"string"==typeof r.impstring&&(t(r.impstring,r),y(s).triggerHandler("jqGridImportComplete",[r.impstring,r]),y.isFunction(r.importComplete)&&r.importComplete(r.impstring))}}}),y.jgrid.extend({jqGridExport:function(t){t=y.extend({exptype:"xmlstring",root:"grid",ident:"\t",addOptions:{},data:!0},t||{});var r=null;return this.each(function(){if(this.grid){var e=y.extend(!0,{},y(this).jqGrid("getGridParam"),t.addOptions);switch(e.rownumbers&&(e.colNames.splice(0,1),e.colModel.splice(0,1)),e.multiselect&&(e.colNames.splice(0,1),e.colModel.splice(0,1)),e.subGrid&&(e.colNames.splice(0,1),e.colModel.splice(0,1)),e.knv=null,t.data||(e.data=[],e._index={}),t.exptype){case"xmlstring":r="<"+t.root+">"+y.jgrid.jsonToXML(e,{xmlDecl:""})+"</"+t.root+">";break;case"jsonstring":r=y.jgrid.stringify(e),t.root&&(r="{"+t.root+":"+r+"}")}}}),r},excelExport:function(p){return p=y.extend({exptype:"remote",url:null,oper:"oper",tag:"excel",beforeExport:null,exporthidden:!1,exportgrouping:!1,exportOptions:{}},p||{}),this.each(function(){if(this.grid&&"remote"===p.exptype){var e,t,r=y.extend({},this.p.postData);if(r[p.oper]=p.tag,y.isFunction(p.beforeExport)&&(t=p.beforeExport.call(this,r),y.isPlainObject(t)&&(r=t)),p.exporthidden){for(var i=this.p.colModel,o=i.length,a=[],n=0;n<o;n++)void 0===i[n].hidden&&(i[n].hidden=!1),a.push({name:i[n].name,hidden:i[n].hidden});var d=JSON.stringify(a);"string"==typeof d&&(r.colModel=d)}p.exportgrouping&&"string"==typeof(e=JSON.stringify(this.p.groupingView))&&(r.groupingView=e);var s=jQuery.param(r),l=-1!==p.url.indexOf("?")?p.url+"&"+s:p.url+"?"+s;window.location=l}})}})});