!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],e):e(jQuery)}(function(B){"use strict";B.assocArraySize=function(e){var r,o=0;for(r in e)e.hasOwnProperty(r)&&o++;return o},B.jgrid.extend({pivotSetup:function(N,e){var k=[],G=[],M=[],z=[],A=[],V={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},q=[],Q=B.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},e||{});return this.each(function(){var e,p,f,d,r,o,i=this,t=N.length,n=0;function a(e,r,o){var t=function(e,r){var o,t,n,a=[];if(!this||"function"!=typeof e||e instanceof RegExp)throw new TypeError;for(n=this.length,o=0;o<n;o++)if(this.hasOwnProperty(o)&&(t=this[o],e.call(r,t,o,this))){a.push(t);break}return a}.call(e,r,o);return 0<t.length?t[0]:null}function s(e,r){var o,t=0,n=!0;for(o in e)if(e.hasOwnProperty(o)){if(e[o]!=this[t]){n=!1;break}if(++t>=this.length)break}return n&&(w=r),n}function h(e,r,o,t,n){var a;if(B.isFunction(e))a=e.call(i,r,o,t);else switch(e){case"sum":a=parseFloat(r||0)+parseFloat(t[o]||0);break;case"count":""!==r&&null!=r||(r=0),a=t.hasOwnProperty(o)?r+1:0;break;case"min":a=""===r||null==r?parseFloat(t[o]||0):Math.min(parseFloat(r),parseFloat(t[o]||0));break;case"max":a=""===r||null==r?parseFloat(t[o]||0):Math.max(parseFloat(r),parseFloat(t[o]||0));break;case"avg":a=(parseFloat(r||0)*(n-1)+parseFloat(t[o]||0))/n}return a}function l(e,r,o,t){var n,a,i,s,l,g=r.length,u="",m=[],p=1;for(B.isArray(o)?(i=o.length,m=o):(i=1,m[0]=o),A=[],a=(z=[]).root=0;a<i;a++){for(var f,d=[],c=0;c<g;c++){if(s="string"==typeof r[c].aggregator?r[c].aggregator:"cust",null==o)f=n=B.trim(r[c].member)+"_"+s,m[0]=r[c].label||s+" "+B.trim(r[c].member);else{f=o[a].replace(/\s+/g,"");try{n=1===g?u+f:u+f+"_"+s+"_"+String(c)}catch(e){}m[a]=o[a]}n=isNaN(parseInt(n,10))?n:n+" ","avg"===r[c].aggregator&&(l=-1===w?G.length+"_"+n:w+"_"+n,v[l]?v[l]++:v[l]=1,p=v[l]),t[n]=d[n]=h(r[c].aggregator,t[n],r[c].member,e,p)}u+=o&&null!=o[a]?o[a].replace(/\s+/g,""):"",z[n]=d,A[n]=m[a]}return t}if(Q.rowTotals&&0<Q.yDimension.length&&(r=Q.yDimension[0].dataName,Q.yDimension.splice(0,0,{dataName:r}),Q.yDimension[0].converter=function(){return"_r_Totals"}),p=B.isArray(Q.xDimension)?Q.xDimension.length:0,f=Q.yDimension.length,d=B.isArray(Q.aggregates)?Q.aggregates.length:0,0===p||0===d)throw"xDimension or aggregates optiona are not set!";for(x=0;x<p;x++)o={name:Q.xDimension[x].dataName,frozen:Q.frozenStaticCols},null==Q.xDimension[x].isGroupField&&(Q.xDimension[x].isGroupField=!0),o=B.extend(!0,o,Q.xDimension[x]),k.push(o);for(var g=p-1,u={},v=[];n<t;){e=N[n];for(var m=[],c=[],y={},x=0;m[x]=B.trim(e[Q.xDimension[x].dataName]),y[Q.xDimension[x].dataName]=m[x],++x<p;);var D,b=0,w=-1;if(D=a(G,s,m)){if(0<=w){if(b=0,1<=f){for(b=0;b<f;b++)c[b]=B.trim(e[Q.yDimension[b].dataName]),Q.yDimension[b].converter&&B.isFunction(Q.yDimension[b].converter)&&(c[b]=Q.yDimension[b].converter.call(this,c[b],m,c));D=l(e,Q.aggregates,c,D)}else 0===f&&(D=l(e,Q.aggregates,null,D));G[w]=D}}else{if(b=0,1<=f){for(b=0;b<f;b++)c[b]=B.trim(e[Q.yDimension[b].dataName]),Q.yDimension[b].converter&&B.isFunction(Q.yDimension[b].converter)&&(c[b]=Q.yDimension[b].converter.call(this,c[b],m,c));y=l(e,Q.aggregates,c,y)}else 0===f&&(y=l(e,Q.aggregates,null,y));G.push(y)}var F,O=0,j=null,S=null;for(F in z)if(z.hasOwnProperty(F)){if(0===O)u.children&&void 0!==u.children||(u={text:F,level:0,children:[],label:F}),j=u.children;else{for(S=null,x=0;x<j.length;x++)if(j[x].text===F){S=j[x];break}j=S?S.children:(j.push({children:[],text:F,level:O,fields:z[F],label:A[F]}),j[j.length-1].children)}O++}n++}v=null;var T,C=[],P=k.length,_=P;if(0<f&&(q[f-1]={useColSpanStyle:!1,groupHeaders:[]}),function e(r){var o,t,n,a,i;for(n in r)if(r.hasOwnProperty(n)){if("object"!=typeof r[n]){if("level"===n){if(void 0===C[r.level]&&(C[r.level]="",0<r.level&&-1===r.text.indexOf("_r_Totals")&&(q[r.level-1]={useColSpanStyle:!1,groupHeaders:[]})),C[r.level]!==r.text&&r.children.length&&-1===r.text.indexOf("_r_Totals")&&0<r.level){q[r.level-1].groupHeaders.push({titleText:r.label,numberOfColumns:0});var s=q[r.level-1].groupHeaders.length-1,l=0==s?_:P;if(r.level-1==(Q.rowTotals?1:0)&&0<s){for(var g=0,u=0;u<s;u++)g+=q[r.level-1].groupHeaders[u].numberOfColumns;g&&(l=g+p)}k[l]&&(q[r.level-1].groupHeaders[s].startColumnName=k[l].name,q[r.level-1].groupHeaders[s].numberOfColumns=k.length-l),P=k.length}C[r.level]=r.text}if(r.level===f&&"level"===n&&0<f)if(1<d){var m=1;for(o in r.fields)r.fields.hasOwnProperty(o)&&(1===m&&q[f-1].groupHeaders.push({startColumnName:o,numberOfColumns:1,titleText:r.label||r.text}),m++);q[f-1].groupHeaders[q[f-1].groupHeaders.length-1].numberOfColumns=m-1}else q.splice(f-1,1)}if(null!=r[n]&&"object"==typeof r[n]&&e(r[n]),"level"===n&&0<r.level&&(r.level===(0===f?r.level:f)||-1!==C[r.level].indexOf("_r_Totals")))for(o in t=0,r.fields)if(r.fields.hasOwnProperty(o)){for(a in i={},Q.aggregates[t])if(Q.aggregates[t].hasOwnProperty(a))switch(a){case"member":case"label":case"aggregator":break;default:i[a]=Q.aggregates[t][a]}1<d?(i.name=o,i.label=Q.aggregates[t].label||r.label):(i.name=r.text,i.label="_r_Totals"===r.text?Q.rowTotalsText:r.label),k.push(i),t++}}}(u),Q.colTotals)for(var H=G.length;H--;)for(x=p;x<k.length;x++)T=k[x].name,M[T]?M[T]+=parseFloat(G[H][T]||0):M[T]=parseFloat(G[H][T]||0);if(0<g)for(x=0;x<g;x++)k[x].isGroupField&&(V.groupingView.groupField.push(k[x].name),V.groupingView.groupSummary.push(Q.groupSummary),V.groupingView.groupSummaryPos.push(Q.groupSummaryPos));else V.grouping=!1;V.sortname=k[g].name,V.groupingView.hideFirstGroupCol=!0}),{colModel:k,rows:G,groupOptions:V,groupHeaders:q,summary:M}},jqPivot:function(o,u,m,t){return this.each(function(){var g=this,e=m.regional?m.regional:"en";function r(e){B.isFunction(u.onInitPivot)&&u.onInitPivot.call(g),B.isArray(e)||(e=[]);var r,o,t,n,a=jQuery(g).jqGrid("pivotSetup",e,u),i=0<B.assocArraySize(a.summary),s=B.jgrid.from.call(g,a.rows);for(u.ignoreCase&&(s=s.ignoreCase()),r=0;r<a.groupOptions.groupingView.groupField.length;r++)o=u.xDimension[r].sortorder?u.xDimension[r].sortorder:"asc",t=u.xDimension[r].sorttype?u.xDimension[r].sorttype:"text",s.orderBy(a.groupOptions.groupingView.groupField[r],o,t,"",t);if(n=u.xDimension.length,m.sortname){for(o=m.sortorder?m.sortorder:"asc",t="text",r=0;r<n;r++)if(u.xDimension[r].dataName===m.sortname){t=u.xDimension[r].sorttype?u.xDimension[r].sorttype:"text";break}s.orderBy(m.sortname,o,t,"",t)}else a.groupOptions.sortname&&n&&(o=u.xDimension[n-1].sortorder?u.xDimension[n-1].sortorder:"asc",t=u.xDimension[n-1].sorttype?u.xDimension[n-1].sorttype:"text",s.orderBy(a.groupOptions.sortname,o,t,"",t));jQuery(g).jqGrid(B.extend(!0,{datastr:B.extend(s.select(),i?{userdata:a.summary}:{}),datatype:"jsonstring",footerrow:i,userDataOnFooter:i,colModel:a.colModel,viewrecords:!0,formatFooterData:!0===u.colTotals,sortname:u.xDimension[0].dataName},a.groupOptions,m||{}));var l=a.groupHeaders;if(l.length)for(r=0;r<l.length;r++)l[r]&&l[r].groupHeaders.length&&jQuery(g).jqGrid("setGroupHeaders",l[r]);u.frozenStaticCols&&jQuery(g).jqGrid("setFrozenColumns"),B.isFunction(u.onCompletePivot)&&u.onCompletePivot.call(g),u.loadMsg&&B(".loading_pivot").remove()}void 0===u.loadMsg&&(u.loadMsg=!0),u.loadMsg&&B("<div class='loading_pivot ui-state-default ui-state-active row'>"+B.jgrid.getRegional(g,"regional."+e+".defaults.loadtext")+"</div>").insertBefore(g).show(),"string"==typeof o?B.ajax(B.extend({url:o,dataType:"json",success:function(e){r(B.jgrid.getAccessor(e,t&&t.reader?t.reader:"rows"))}},t||{})):r(o)})}})});